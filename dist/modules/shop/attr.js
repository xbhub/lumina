"use strict";layui.define(["laytpl","admin","util"],function(t){var s=layui.jquery,p=(layui.laytpl,layui.admin,layui.util,layui.layer),d={spec_attr:[],spec_list:[]},n={container:".goods-spec-many"};t("attr",{initialize:function(){this.$container=s(n.container),this.batchUpdateSku(),this.updateSpecInputEvent(),this.renderHtml()},showAddSpecGroupEvent:function(){},submitAddSpecGroupEvent:function(){var l=this;l.$container.on("click",".btn-addSpecName",function(){var e=s(this).parent().parent(),n=e.prev(),i=l.$container.find(".input-specName"),a=l.$container.find(".input-specValue"),t=a.val(),r=i.val();if(""===r||""===t)return p.msg("请填写规则名或规则值"),!1;var c=p.load();layui.util.request.post("/api/attr/create",{label:r,value:t},function(t){t=t.data;p.close(c),i.val("")&&a.val(""),d.spec_attr.push({id:t.spec_id,label:r,children:[{id:t.id,label:t.value}]}),l.renderHtml(),e.hide()&&n.show()})})},cancelAddSpecGroupEvent:function(){this.$container.on("click",".btn-cancleAddSpecName",function(){var t=s(this).parent().parent(),e=t.prev();t.hide()&&e.show()})},addSpecItemEvent:function(){var a=this;a.$container.on("click",".btn-addSpecItem",function(){var t=s(this),e=t.parents(".spec-item-add").find("input").val(),n=t.parents(".spec-group-item");if(""===e)return p.msg("规格值不能为空"),!1;var i=p.load();layui.util.request.post("/api/attr/val/create",{spec_id:n.data("group-id"),value:e},function(t){p.close(i),d.spec_attr[n.data("index")].children.push({id:t.data.id,label:e}),a.renderHtml()})})},deleteSpecGroupEvent:function(){var n=this;n.$container.on("click",".spec-group-delete",function(){var e=s(this).parent().parent().attr("data-index");p.confirm("确定要删除该规则组吗？确认后不可恢复请谨慎操作",function(t){d.spec_attr.splice(e,1),n.renderHtml(),p.close(t)})})},deleteSpecItemEvent:function(){var i=this;i.$container.on("click",".spec-item-delete",function(){var t=s(this).parent(),e=t.parent().parent().attr("data-index"),n=t.attr("data-item-index");p.confirm("确定要删除该规则吗？确认后不可恢复请谨慎操作",function(t){d.spec_attr[e].children.splice(n,1),i.renderHtml(),p.close(t)})})},batchUpdateSku:function(){var t=this,e=t.$container.find(".spec-batch");e.on("click",".btn-specBatchBtn",function(){var n={};e.find("input").each(function(){var t=s(this),e=t.data("type"),t=t.val();void 0!==e&&""!==e&&""!==t&&(n[e]=t)}),s.isEmptyObject(n)||(d.spec_list.forEach(function(t,e){d.spec_list[e].form=s.extend({},d.spec_list[e].form,n)}),t.renderTabelHtml())})},renderHtml:function(){this.renderTabelHtml()},renderTabelHtml:function(){var t=this.$container.find(".spec-sku-tabel"),e=t.parent();if(0===d.spec_attr.length)return t.empty(),e.hide(),!1;this.buildSpeclist(),t.html(template("tpl_spec_table",d)),e.show()},buildSpeclist:function(){for(var t=1,e=0;e<d.spec_attr.length;e++)t*=d.spec_attr[e].children.length;for(var n=[],e=0;e<t;e++){for(var i=[],a=1,r=[],c=0;c<d.spec_attr.length;c++){var l=d.spec_attr[c].children,s=t/(a*=l.length),p=e/s%l.length;0==e%s&&i.push({rowspan:s,id:l[p].id,label:l[p].label}),r.push(l[parseInt(p.toString())].id)}n.push({spec_val_ids:r.join(","),rows:i,form:{}})}if(0<d.spec_list.length&&0<n.length)for(e=0;e<n.length;e++){var o=d.spec_list.filter(function(t){return t.spec_val_ids===n[e].spec_val_ids});0<o.length&&(n[e].form=o[0].form)}d.spec_list=n},updateSpecInputEvent:function(){this.$container.find(".spec-sku-tabel").on("propertychange change","input",function(){var t=s(this),e=t.attr("label"),n=t.parent().parent().data("index");d.spec_list[n].form[e]=t.val()})},getData:function(){return d},isEmptySkuList:function(){return!d.spec_list.length},render:function(t,e){n=s.extend(!0,{},n,t),null!=e&&(d=e),this.initialize()}})});