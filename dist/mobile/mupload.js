"use strict";layui.define(function(e){function d(t,n){try{return new Blob(t,{type:n})}catch(e){var r=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MSBlobBuilder);return t.forEach(function(e){r.append(e)}),r.getBlob(n)}}function u(){var a=this,o=[],i=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),s=XMLHttpRequest.prototype.send;this.append=function(e,t,n){o.push("--"+i+'\r\nContent-Disposition: form-data; name="'+e+'"'),t instanceof Blob?(o.push('; filename="'+(n||"blob")+'"\r\nContent-Type: '+t.type+"\r\n\r\n"),o.push(t)):o.push("\r\n\r\n"+t),o.push("\r\n")},XMLHttpRequest.prototype.send=function(e){var t,n,r=this;e===a?(o.push("--"+i+"--\r\n"),n=d(o),(t=new FileReader).onload=function(){s.call(r,t.result)},t.onerror=function(e){throw e},t.readAsArrayBuffer(n),this.setRequestHeader("Content-Type","multipart/form-data; boundary="+i),XMLHttpRequest.prototype.send=s):s.call(this,e)}}document.getElementById("choose");var p=document.createElement("canvas"),c=p.getContext("2d"),h=document.createElement("canvas"),f=h.getContext("2d"),g={elem:"j_mupload",url:"/api/upload",done:{}};e("mupload",{render:function(e){var o=this;g=$.extend(g,e),$(g.elem)[0].onchange=function(){var e;this.files.length&&(1<(e=Array.prototype.slice.call(this.files)).length?alert("最多同时只可上传1张图片"):e.forEach(function(r,e){var t,a;/\/(?:jpeg|png|gif)/i.test(r.type)&&(t=new FileReader,a=document.createElement("li"),1024<r.size/1024?r.size:r.size,a.innerHTML='<div class="progress"><span></span></div>',$(".img-list").append($(a)),t.onload=function(){function e(){var e=o.compress(n);o.upload(e,r.type,$(a)),n=null}var t=this.result,n=new Image;if(n.src=t,$(a).css("background-image","url("+t+")"),t.length<=102400)return n=null,void o.upload(t,r.type,$(a));n.complete?e():n.onload=e},t.readAsDataURL(r))}))},$(g.elem).click()},compress:function(e){e.src.length;var t,n=e.width,r=e.height;if(1<(t=n*r/4e6)?(n/=t=Math.sqrt(t),r/=t):t=1,p.width=n,p.height=r,c.fillStyle="#fff",c.fillRect(0,0,p.width,p.height),1<(a=n*r/1e6)){var a,o=~~(n/(a=~~(Math.sqrt(a)+1))),i=~~(r/a);h.width=o,h.height=i;for(var s=0;s<a;s++)for(var l=0;l<a;l++)f.drawImage(e,s*o*t,l*i*t,o*t,i*t,0,0,o,i),c.drawImage(h,s*o,l*i,o,i)}else c.drawImage(e,0,0,n,r);r=p.toDataURL("image/jpeg",.1);return h.width=h.height=p.width=p.height=0,r},upload:function(e,t,n){for(var r=window.atob(e.split(",")[1]),a=new Uint8Array(r.length),o=0,i=null,s=0;s<r.length;s++)a[s]=r.charCodeAt(s);var e=d([a],t),l=new XMLHttpRequest,t=new(~navigator.userAgent.indexOf("Android")&&~navigator.vendor.indexOf("Google")&&!~navigator.userAgent.indexOf("Chrome")&&navigator.userAgent.match(/AppleWebKit\/(\d+)/).pop()<=534?u:FormData);t.append("file",e),l.open("post",g.url),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.setRequestHeader("X-CSRF-TOKEN",$('meta[name="csrf-token"]').attr("content")),l.onreadystatechange=function(){var e,t;4==l.readyState&&200==l.status&&(e=JSON.parse(l.responseText).data||{},t=e.url?"上传成功":"上传失败",clearInterval(i),n.find(".progress span").animate({width:"100%"},o<95?200:0,function(){$(this).html(t)}),e.url&&"function"==typeof g.done&&g.done(e.url))},l.upload.addEventListener("progress",function(e){i||(o=~~(100*e.loaded/e.total)/2,n.find(".progress span").css("width",o+"%"),50==o&&(i=i||setInterval(function(){o++,n.find(".progress span").css("width",o+"%"),99==o&&clearInterval(i)},100)))},!1),l.send(t)}})});